<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Income & Expense Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #3498db;
            --accent-color: #f1c40f;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --white-color: #fff;
            --text-color: #ecf0f1;
        }

        @keyframes gradient-animation { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes toast-in { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #2c3e50, #34495e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradient-animation 15s ease infinite;
            color: var(--text-color); min-height: 100vh; padding: 20px;
            display: flex; align-items: flex-start; justify-content: center;
        }

        .container {
            width: 100%; max-width: 1300px; padding: 40px;
            background: rgba(0, 0, 0, 0.3); border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            animation: slideInUp 0.8s ease-out;
        }
        
        .dashboard { display: grid; grid-template-columns: 1fr; gap: 40px; }
        @media (min-width: 992px) { .dashboard { grid-template-columns: 5fr 4fr; } }
        .main-content, .visual-content { display: flex; flex-direction: column; }
        
        h1 { font-size: 2.8rem; text-align: center; margin-bottom: 10px; font-weight: 700; background: linear-gradient(45deg, var(--white-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 2px 2px 10px rgba(0,0,0,0.2); }
        h2 { font-size: 1.8rem; text-align: center; color: var(--white-color); margin: 0 0 25px 0; font-weight: 700; }
        
        .greeting-container {
            display: flex; align-items: center; justify-content: center;
            gap: 15px; margin-bottom: 25px;
        }
        .user-greeting-style {
            font-size: 1.5rem; font-weight: 400; margin: 0;
            color: rgba(255, 255, 255, 0.9); animation: fadeIn 1.2s ease-out;
        }
        #change-name-btn {
            background: none; border: none; cursor: pointer;
            font-size: 1.5rem; color: var(--accent-color);
            opacity: 0.7; transition: all 0.3s ease;
        }
        #change-name-btn:hover {
            opacity: 1; transform: rotate(15deg) scale(1.1);
        }

        .section-header { border-top: 1px solid rgba(255,255,255,0.2); padding-top: 25px; }

        .balance-display { text-align: center; margin-bottom: 20px; }
        .balance-display h3 { font-weight: 400; font-size: 1rem; color: rgba(255, 255, 255, 0.8); }
        .balance-display #current-balance { font-size: 3.2rem; font-weight: 700; }
        
        .summary-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); animation: slideInUp 0.6s ease-out forwards; opacity: 0; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .summary-card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .summary-card:nth-child(1) { animation-delay: 0.1s; border-left: 5px solid var(--success-color); }
        .summary-card:nth-child(2) { animation-delay: 0.2s; border-left: 5px solid var(--danger-color); }
        .summary-card:nth-child(3) { animation-delay: 0.3s; border-left: 5px solid var(--accent-color); }
        .summary-card:nth-child(4) { animation-delay: 0.4s; border-left: 5px solid var(--secondary-color); }
        .summary-card .summary-icon { font-size: 2rem; }
        .summary-card h4 { font-size: 0.9rem; font-weight: 600; margin: 10px 0; color: rgba(255,255,255,0.8); }
        .summary-card p { font-size: 1.5rem; font-weight: 700; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .form-control.full-width { grid-column: 1 / -1; }
        .form-control { display: flex; flex-direction: column; }
        .form-control .label-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        label { font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, select { padding: 15px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; font-size: 16px; background: rgba(0, 0, 0, 0.2); color: var(--white-color); transition: all 0.3s ease; font-family: 'Poppins', sans-serif; }
        select { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        input:focus, select:focus { outline: none; background: rgba(0, 0, 0, 0.3); border-color: var(--primary-color); box-shadow: 0 0 10px rgba(142, 68, 173, 0.5); }

        .btn { padding: 15px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; text-align: center; transition: all 0.3s ease; letter-spacing: 0.5px; }
        .btn-small { padding: 5px 10px; font-size: 1rem; font-weight: 700; background: rgba(255, 255, 255, 0.1); color: var(--white-color); border: 1px solid rgba(255,255,255,0.2); }
        .btn-small:hover { background: rgba(255, 255, 255, 0.2); }
        .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: var(--white-color); }
        .btn-danger { background-color: var(--danger-color); color: var(--white-color); }
        
        .action-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; transition: all 0.3s ease; padding: 5px; color: var(--text-color); opacity: 0.7; }
        .action-btn:hover { opacity: 1; transform: scale(1.2); }
        
        .global-actions { display: flex; justify-content: space-between; gap: 15px; margin-top: 40px; }
        
        .table-border-wrapper { padding: 2px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color), var(--accent-color)); background-size: 200% 200%; animation: gradient-animation 8s ease infinite; border-radius: 10px; margin-top: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .transaction-table-container { max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.4); border-radius: 8px; }
        .transaction-table-container::-webkit-scrollbar { width: 8px; }
        .transaction-table-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .transaction-table-container::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }
        .transaction-table { width: 100%; border-collapse: collapse; }
        .transaction-table th, .transaction-table td { padding: 12px 15px; text-align: left; vertical-align: middle; border: 1px solid rgba(255, 255, 255, 0.1); }
        .transaction-table th.col-actions { text-align: center; }
        .transaction-table td.col-actions { text-align: center; }
        .transaction-table thead { position: sticky; top: 0; z-index: 10; background: rgba(0, 0, 0, 0.4); }
        .transaction-table tbody tr { transition: background-color 0.3s ease; animation: slideInUp 0.5s ease-out forwards; }
        .transaction-table .category-Food { border-left: 5px solid #e67e22; }
        .transaction-table .category-Transport { border-left: 5px solid #3498db; }
        .transaction-table .category-Bills { border-left: 5px solid #e74c3c; }
        .transaction-table .category-Shopping { border-left: 5px solid #9b59b6; }
        .transaction-table .category-Entertainment { border-left: 5px solid #1abc9c; }
        .transaction-table .category-Other, .transaction-table .category-custom { border-left: 5px solid #f1c40f; }
        .transaction-table .category-Income { border-left: 5px solid var(--success-color); }
        .col-amount.income { color: var(--success-color) !important; }
        .col-amount.expense { color: var(--danger-color) !important; }

        #chart-container { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; min-height: 400px; display: flex; align-items: center; justify-content: center; position: relative; }
        #chart-placeholder { text-align: center; font-style: italic; color: rgba(255,255,255,0.6); }

        .developer-credit { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.9rem; font-weight: 400; background: linear-gradient(90deg, var(--secondary-color), var(--white-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: fadeIn 1.5s ease; text-shadow: 1px 1px 5px rgba(0,0,0,0.2); }
        
        /* Modal Styles */
        .hidden { display: none !important; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .modal-overlay:not(.hidden) { opacity: 1; }
        .modal-content { background: rgba(44, 62, 80, 0.9); padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 15px; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; text-align: left; }
        .close-btn { background: none; border: none; color: var(--white-color); font-size: 2rem; cursor: pointer; line-height: 1; transition: transform 0.2s ease, color 0.2s ease; }
        .close-btn:hover { transform: rotate(90deg); color: var(--danger-color); }
        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 15px; }

        /* Welcome Modal Specific Styles */
        #welcome-modal-content { text-align: center; }
        #welcome-modal-content h2 { font-size: 2rem; margin-bottom: 15px; background: linear-gradient(45deg, var(--white-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #welcome-modal-content p { margin-bottom: 25px; font-size: 1rem; color: rgba(255,255,255,0.8); }
        #user-name-input { text-align: center; font-size: 1.2rem; padding: 18px; margin-bottom: 20px; width: 100%; }
        
        /* Toast Notification Styles */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 25px; border-radius: 8px; color: var(--white-color); font-size: 1rem; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; animation: toast-in 0.5s ease forwards; }
        .toast.fade-out { animation: toast-out 0.5s ease forwards; }
        .toast.success { background: linear-gradient(45deg, var(--success-color), #27ae60); }
        .toast.danger { background: linear-gradient(45deg, var(--danger-color), #c0392b); }
        .toast.info { background: linear-gradient(45deg, var(--secondary-color), #2980b9); }
    </style>
</head>
<body>
    <div class="container">
        <h1>Income & Expense Tracker</h1>
        <div class="greeting-container">
            <h2 id="user-greeting" class="user-greeting-style"></h2>
            <button id="change-name-btn" title="Change Name">✏️</button>
        </div>
        <div class="balance-display">
            <h3>Current Balance</h3>
            <div id="current-balance">₹0.00</div>
        </div>

        <div class="summary-container">
            <div class="summary-card">
                <div class="summary-icon">💰</div>
                <h4>Total Income</h4>
                <p id="summary-income" data-current-value="0">₹0.00</p>
            </div>
            <div class="summary-card">
                <div class="summary-icon">📤</div>
                <h4>Total Expenses</h4>
                <p id="summary-expenses" data-current-value="0">₹0.00</p>
            </div>
            <div class="summary-card">
                <div class="summary-icon">🗓️</div>
                <h4>This Month's Expenses</h4>
                <p id="summary-monthly-expenses" data-current-value="0">₹0.00</p>
            </div>
             <div class="summary-card">
                <div class="summary-icon">🧾</div>
                <h4>Transactions</h4>
                <p id="summary-count" data-current-value="0">0</p>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="main-content">
                <h2 class="section-header">New Transaction</h2>
                <form id="transaction-form">
                    <div class="form-grid">
                        <div class="form-control">
                            <label for="transaction-type">Type</label>
                            <select id="transaction-type" required>
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                            </select>
                        </div>
                         <div class="form-control">
                            <label for="transaction-date">Date</label>
                            <input type="date" id="transaction-date" required>
                        </div>
                        <div class="form-control full-width" id="category-form-control">
                            <div class="label-header">
                                <label for="transaction-category">Category</label>
                                <button type="button" id="add-category-btn" class="btn btn-small" title="Add New Category">+</button>
                            </div>
                            <select id="transaction-category" required></select>
                        </div>
                        <div class="form-control full-width">
                            <label for="transaction-description">Description</label>
                            <input type="text" id="transaction-description" required list="description-suggestions">
                            <datalist id="description-suggestions"></datalist>
                        </div>
                        <div class="form-control full-width">
                            <label for="transaction-amount">Amount (₹)</label>
                            <input type="number" id="transaction-amount" step="0.01" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Add Transaction</button>
                </form>
            </div>

            <div class="visual-content">
                <h2 class="section-header">Expense Analysis</h2>
                <div id="chart-container">
                    <canvas id="expense-chart"></canvas>
                    <p id="chart-placeholder">Add an expense to see the chart.</p>
                </div>
            </div>
        </div>

        <div class="main-table-section">
            <h2 class="section-header">Transaction Details</h2>
            <div class="table-border-wrapper">
                <div class="transaction-table-container">
                    <table class="transaction-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th class="col-amount">Amount</th>
                                <th class="col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="global-actions">
            <button id="send-email-btn" class="btn btn-primary">Send Report to Email</button>
            <button id="clear-data-btn" class="btn btn-danger">Clear All Data</button>
        </div>
        
        <div class="developer-credit">
            Developed By Lav Sharma
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Transaction</h2>
                <button id="close-modal-btn" class="close-btn" title="Close">×</button>
            </div>
            <div class="modal-body">
                <form id="edit-transaction-form">
                    <input type="hidden" id="edit-transaction-id">
                    <div class="form-grid">
                        <div class="form-control">
                            <label for="edit-transaction-type">Type</label>
                            <select id="edit-transaction-type" required>
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                            </select>
                        </div>
                        <div class="form-control">
                            <label for="edit-transaction-date">Date</label>
                            <input type="date" id="edit-transaction-date" required>
                        </div>
                        <div class="form-control full-width" id="edit-category-form-control">
                            <label for="edit-transaction-category">Category</label>
                            <select id="edit-transaction-category" required></select>
                        </div>
                        <div class="form-control full-width">
                            <label for="edit-transaction-description">Description</label>
                            <input type="text" id="edit-transaction-description" required>
                        </div>
                        <div class="form-control full-width">
                            <label for="edit-transaction-amount">Amount (₹)</label>
                            <input type="number" id="edit-transaction-amount" step="0.01" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancel-edit-btn" class="btn btn-danger">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div id="welcome-modal-overlay" class="modal-overlay hidden">
        <div id="welcome-modal-content" class="modal-content">
            <h2 id="welcome-modal-title">Welcome!</h2>
            <p id="welcome-modal-text">Please enter your name to get started.</p>
            <form id="welcome-form">
                <input type="text" id="user-name-input" placeholder="Your Name" required>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Continue</button>
            </form>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toastContainer = document.getElementById('toast-container');
            const showToast = (message, type = 'info') => {
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                const iconMap = { success: '✅', danger: '❌', info: 'ℹ️' };
                toast.innerHTML = `${iconMap[type] || '🔔'}   ${message}`;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                }, 3000);
            };

            const greetingElement = document.getElementById('user-greeting');
            const changeNameBtn = document.getElementById('change-name-btn');
            const welcomeModalOverlay = document.getElementById('welcome-modal-overlay');
            const welcomeModalTitle = document.getElementById('welcome-modal-title');
            const welcomeModalText = document.getElementById('welcome-modal-text');
            const welcomeForm = document.getElementById('welcome-form');
            const userNameInput = document.getElementById('user-name-input');
            const transactionForm = document.getElementById('transaction-form');
            const transactionTableBody = document.getElementById('transaction-table-body');
            const currentBalanceDisplay = document.getElementById('current-balance');
            const summaryIncomeEl = document.getElementById('summary-income');
            const summaryExpensesEl = document.getElementById('summary-expenses');
            const summaryMonthlyExpensesEl = document.getElementById('summary-monthly-expenses');
            const summaryCountEl = document.getElementById('summary-count');
            const transactionTypeSelect = document.getElementById('transaction-type');
            const categoryFormControl = document.getElementById('category-form-control');
            const addCategoryBtn = document.getElementById('add-category-btn');
            const expenseChartCanvas = document.getElementById('expense-chart');
            const chartPlaceholder = document.getElementById('chart-placeholder');
            const descriptionDatalist = document.getElementById('description-suggestions');
            const sendEmailBtn = document.getElementById('send-email-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const editModalOverlay = document.getElementById('edit-modal-overlay');
            const editTransactionForm = document.getElementById('edit-transaction-form');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const editTransactionIdInput = document.getElementById('edit-transaction-id');
            const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
            const editTransactionDateInput = document.getElementById('edit-transaction-date');
            const editCategoryFormControl = document.getElementById('edit-category-form-control');
            const editTransactionCategorySelect = document.getElementById('edit-transaction-category');
            const editTransactionDescriptionInput = document.getElementById('edit-transaction-description');
            const editTransactionAmountInput = document.getElementById('edit-transaction-amount');

            const USER_NAME_KEY = 'trackerUserName';
            const DEFAULT_CATEGORIES = ["Food", "Transport", "Bills", "Shopping", "Entertainment", "Other"];
            const CUSTOM_CATEGORIES_KEY = 'customExpenseCategories';
            const SAVED_DESCRIPTIONS_KEY = 'savedExpenseDescriptions';
            let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            let customCategories = JSON.parse(localStorage.getItem(CUSTOM_CATEGORIES_KEY)) || [];
            let expenseChart = null;
            
            function setupUserGreeting() {
                const savedName = localStorage.getItem(USER_NAME_KEY);
                if (savedName) {
                    greetingElement.textContent = `Welcome back, ${savedName}!`;
                } else {
                    welcomeModalTitle.textContent = 'Welcome!';
                    welcomeModalText.textContent = 'Please enter your name to get started.';
                    userNameInput.value = '';
                    welcomeModalOverlay.classList.remove('hidden');
                    userNameInput.focus();
                }
            }

            changeNameBtn.addEventListener('click', () => {
                const currentName = localStorage.getItem(USER_NAME_KEY) || '';
                welcomeModalTitle.textContent = 'Change Your Name';
                welcomeModalText.textContent = 'Enter a new name below.';
                userNameInput.value = currentName;
                welcomeModalOverlay.classList.remove('hidden');
                userNameInput.focus();
            });

            welcomeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                let userName = userNameInput.value.trim();
                if (userName === '') { userName = 'Guest'; }
                const oldName = localStorage.getItem(USER_NAME_KEY);
                localStorage.setItem(USER_NAME_KEY, userName);
                greetingElement.textContent = oldName ? `Welcome back, ${userName}!` : `Welcome, ${userName}!`;
                welcomeModalOverlay.classList.add('hidden');
                if (oldName && oldName !== userName) {
                    showToast('Name updated successfully!', 'success');
                }
            });

            const animateCountUp = (element, endValue, isCurrency) => {
                const duration = 1000;
                const startValue = parseFloat(element.dataset.currentValue || 0);
                if (startValue === endValue) return;
                let startTime = null;
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    const currentValue = progress * (endValue - startValue) + startValue;
                    if (isCurrency) element.textContent = `₹${currentValue.toFixed(2)}`;
                    else element.textContent = Math.floor(currentValue);
                    if (progress < 1) window.requestAnimationFrame(step);
                    else {
                        if (isCurrency) element.textContent = `₹${endValue.toFixed(2)}`;
                        else element.textContent = endValue;
                    }
                };
                window.requestAnimationFrame(step);
                element.dataset.currentValue = endValue;
            };

            const toggleCategoryField = () => {
                categoryFormControl.style.display = transactionTypeSelect.value === 'expense' ? 'flex' : 'none';
            };

            const updateSummaryAndBalance = () => {
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const balance = totalIncome - totalExpenses;
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const monthlyExpenses = transactions
                    .filter(t => {
                        const transactionDate = new Date(t.date + 'T00:00:00');
                        return t.type === 'expense' &&
                               transactionDate.getMonth() === currentMonth &&
                               transactionDate.getFullYear() === currentYear;
                    })
                    .reduce((sum, t) => sum + t.amount, 0);

                currentBalanceDisplay.textContent = `₹${balance.toFixed(2)}`;
                currentBalanceDisplay.style.color = balance >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                animateCountUp(summaryIncomeEl, totalIncome, true);
                animateCountUp(summaryExpensesEl, totalExpenses, true);
                animateCountUp(summaryMonthlyExpensesEl, monthlyExpenses, true);
                animateCountUp(summaryCountEl, transactions.length, false);
            };

            const getAllCategories = () => [...DEFAULT_CATEGORIES, ...customCategories].sort();
            
            const populateCategoryDropdowns = () => {
                const allCategories = getAllCategories();
                const dropdowns = [ document.getElementById('transaction-category'), document.getElementById('edit-transaction-category') ];
                dropdowns.forEach(dropdown => {
                    if (!dropdown) return;
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '';
                    allCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat; option.textContent = cat;
                        dropdown.appendChild(option);
                    });
                    if (allCategories.includes(currentValue)) dropdown.value = currentValue;
                });
            };

             const populateDescriptionDatalist = () => {
                const saved = JSON.parse(localStorage.getItem(SAVED_DESCRIPTIONS_KEY)) || [];
                descriptionDatalist.innerHTML = '';
                saved.forEach(desc => {
                    const option = document.createElement('option');
                    option.value = desc;
                    descriptionDatalist.appendChild(option);
                });
            };
             const updateDescriptionSuggestions = (newDescription) => {
                const description = newDescription.trim();
                if (!description) return;
                let saved = JSON.parse(localStorage.getItem(SAVED_DESCRIPTIONS_KEY)) || [];
                if (!saved.includes(description)) {
                    saved.push(description);
                    localStorage.setItem(SAVED_DESCRIPTIONS_KEY, JSON.stringify(saved));
                    populateDescriptionDatalist();
                }
            };

            const renderTransactions = () => {
                transactionTableBody.innerHTML = '';
                const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

                if (sortedTransactions.length === 0) {
                     transactionTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px 0;">No transactions yet.</td></tr>`;
                } else {
                    sortedTransactions.forEach(transaction => {
                        const tr = document.createElement('tr');
                        const sign = transaction.type === 'income' ? '+' : '-';
                        const amountColorClass = transaction.type;
                        const category = transaction.type === 'income' ? 'Income' : transaction.category;
                        const categoryClass = DEFAULT_CATEGORIES.includes(category) ? category.replace(/\s+/g, '-') : 'custom';
                        const date = new Date(transaction.date + 'T00:00:00');
                        const formattedDate = date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });

                        tr.className = `transaction-item category-${categoryClass}`;
                        tr.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${category}</td>
                            <td>${transaction.description}</td>
                            <td class="col-amount ${amountColorClass}">${sign} ₹${transaction.amount.toFixed(2)}</td>
                            <td class="col-actions">
                                <button class="action-btn edit-btn" data-id="${transaction.id}" title="Edit">✏️</button>
                                <button class="action-btn duplicate-btn" data-id="${transaction.id}" title="Duplicate">📄</button>
                                <button class="action-btn delete-btn" data-id="${transaction.id}" title="Delete">❌</button>
                            </td>
                        `;
                        transactionTableBody.appendChild(tr);
                    });
                }
            };
            
            const prepareChartData = () => {
                const expenseTransactions = transactions.filter(t => t.type === 'expense');
                const categoryTotals = new Map();
                expenseTransactions.forEach(expense => {
                    const total = categoryTotals.get(expense.category) || 0;
                    categoryTotals.set(expense.category, total + expense.amount);
                });
                return { labels: [...categoryTotals.keys()], data: [...categoryTotals.values()] };
            };

            const renderOrUpdateChart = () => {
                const expenseTransactions = transactions.filter(t => t.type === 'expense');
                if (expenseTransactions.length === 0) {
                    chartPlaceholder.style.display = 'block'; expenseChartCanvas.style.display = 'none';
                    if (expenseChart) { expenseChart.destroy(); expenseChart = null; }
                    return;
                }
                chartPlaceholder.style.display = 'none'; expenseChartCanvas.style.display = 'block';
                const { labels, data } = prepareChartData();
                const chartColors = ['#e67e22', '#3498db', '#e74c3c', '#9b59b6', '#1abc9c', '#95a5a6', '#f1c40f', '#2ecc71', '#34495e'];

                if (expenseChart) {
                    expenseChart.data.labels = labels; expenseChart.data.datasets[0].data = data;
                    expenseChart.update();
                } else {
                    const ctx = expenseChartCanvas.getContext('2d');
                    expenseChart = new Chart(ctx, {
                        type: 'doughnut', data: { labels: labels, datasets: [{ label: 'Expenses', data: data, backgroundColor: chartColors, borderColor: 'rgba(44, 62, 80, 0.5)', borderWidth: 2, hoverOffset: 4 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'var(--text-color)', font: { family: "'Poppins', sans-serif" }}}, tooltip: { callbacks: { label: (c) => `${c.label || ''}: ₹${(c.parsed || 0).toFixed(2)}`}}}}
                    });
                }
            };
            
            const saveAndRerender = () => {
                localStorage.setItem('transactions', JSON.stringify(transactions));
                renderTransactions();
                renderOrUpdateChart();
                updateSummaryAndBalance();
            };
            
            transactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const type = transactionTypeSelect.value;
                const description = document.getElementById('transaction-description').value;
                const newTransaction = {
                    id: Date.now(), type: type, date: document.getElementById('transaction-date').value,
                    category: type === 'expense' ? document.getElementById('transaction-category').value : 'Income',
                    description: description, amount: parseFloat(document.getElementById('transaction-amount').value),
                };
                updateDescriptionSuggestions(description);
                transactions.push(newTransaction);
                saveAndRerender();
                showToast('Transaction added successfully!', 'success');
                transactionForm.reset();
                document.getElementById('transaction-date').valueAsDate = new Date();
                toggleCategoryField();
            });
            
            transactionTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('.action-btn');
                if (!button) return;
                const id = parseInt(button.dataset.id);
                if (button.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this transaction?')) {
                        transactions = transactions.filter(t => t.id !== id);
                        saveAndRerender();
                        showToast('Transaction deleted.', 'danger');
                    }
                } else if (button.classList.contains('edit-btn')) {
                    openEditModal(id);
                } else if (button.classList.contains('duplicate-btn')) {
                    handleDuplicate(id);
                }
            });

            addCategoryBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const newCategoryName = prompt('Enter new category name:');
                if (!newCategoryName || newCategoryName.trim() === '') return;
                const trimmedName = newCategoryName.trim();
                if (getAllCategories().map(c => c.toLowerCase()).includes(trimmedName.toLowerCase())) {
                    showToast('This category already exists.', 'info');
                    return;
                }
                customCategories.push(trimmedName);
                localStorage.setItem(CUSTOM_CATEGORIES_KEY, JSON.stringify(customCategories));
                populateCategoryDropdowns();
                document.getElementById('transaction-category').value = trimmedName;
                showToast('New category added!', 'success');
            });

            clearDataBtn.addEventListener('click', () => {
                 if (transactions.length > 0 && confirm('Are you sure you want to delete ALL data?')) {
                    if (confirm('This will also clear all saved descriptions, custom categories, AND your name. This cannot be undone. Are you sure?')) {
                        transactions = []; customCategories = [];
                        localStorage.removeItem('transactions');
                        localStorage.removeItem(SAVED_DESCRIPTIONS_KEY);
                        localStorage.removeItem(CUSTOM_CATEGORIES_KEY);
                        localStorage.removeItem(USER_NAME_KEY);
                        
                        populateDescriptionDatalist(); populateCategoryDropdowns();
                        saveAndRerender();
                        showToast('All data has been cleared.', 'danger');
                        setupUserGreeting();
                    }
                }
            });
            
            sendEmailBtn.addEventListener('click', () => {
                const userName = localStorage.getItem(USER_NAME_KEY) || 'User';
                showToast(`Hi ${userName}, email feature is coming soon!`, 'info');
            });
            
            transactionTypeSelect.addEventListener('change', toggleCategoryField);
            
            const handleDuplicate = (id) => {
                const original = transactions.find(t => t.id === id);
                if (!original) return;
                const newTransaction = { ...original, id: Date.now(), date: new Date().toISOString().split('T')[0] };
                transactions.push(newTransaction);
                saveAndRerender();
                showToast('Transaction duplicated.', 'success');
            };

            const toggleEditCategoryField = () => {
                editCategoryFormControl.style.display = editTransactionTypeSelect.value === 'expense' ? 'flex' : 'none';
            };

            const openEditModal = (id) => {
                const transaction = transactions.find(t => t.id === id);
                if (!transaction) return;
                editTransactionIdInput.value = transaction.id;
                editTransactionTypeSelect.value = transaction.type;
                editTransactionDateInput.value = transaction.date;
                editTransactionDescriptionInput.value = transaction.description;
                editTransactionAmountInput.value = transaction.amount;
                toggleEditCategoryField();
                if (transaction.type === 'expense') { editTransactionCategorySelect.value = transaction.category; }
                editModalOverlay.classList.remove('hidden');
            };

            const closeEditModal = () => { editModalOverlay.classList.add('hidden'); };

            editTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(editTransactionIdInput.value);
                const index = transactions.findIndex(t => t.id === id);
                if (index === -1) return;
                const type = editTransactionTypeSelect.value;
                const description = editTransactionDescriptionInput.value;
                transactions[index] = {
                    id: id, type: type, date: editTransactionDateInput.value,
                    category: type === 'expense' ? editTransactionCategorySelect.value : 'Income',
                    description: description, amount: parseFloat(editTransactionAmountInput.value)
                };
                updateDescriptionSuggestions(description);
                saveAndRerender();
                closeEditModal();
                showToast('Transaction updated successfully.', 'info');
            });

            editTransactionTypeSelect.addEventListener('change', toggleEditCategoryField);
            closeModalBtn.addEventListener('click', closeEditModal);
            cancelEditBtn.addEventListener('click', closeEditModal);
            editModalOverlay.addEventListener('click', (e) => { if (e.target === editModalOverlay) closeEditModal(); });

            // --- Initial Load ---
            setupUserGreeting();
            populateCategoryDropdowns();
            populateDescriptionDatalist();
            toggleCategoryField();
            saveAndRerender();
            document.getElementById('transaction-date').valueAsDate = new Date();
        });
    </script>
</body>
</html>